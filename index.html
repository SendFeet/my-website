<script>
  const content = document.getElementById("content");

  function addBlock(text, className) {
    const div = document.createElement("div");
    div.className = className;
    div.textContent = text;
    content.appendChild(div);
  }

  function addSpacer() {
    const s = document.createElement("div");
    s.className = "spacer";
    content.appendChild(s);
  }

  function addVerse(num, text) {
    const row = document.createElement("div");
    row.className = "verse";

    const n = document.createElement("div");
    n.className = "vnum";
    n.textContent = num || "";

    const t = document.createElement("div");
    t.className = "vtext";
    t.textContent = text;

    row.appendChild(n);
    row.appendChild(t);
    content.appendChild(row);
  }

  async function loadText() {
    try {
      const url = "Story%20of%20Enoch.txt"; // filename has spaces
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("Fetch failed: " + res.status + " " + res.statusText);

      const raw = (await res.text()).replace(/\r/g, "");
      const lines = raw.split("\n");

      content.innerHTML = "";

      let currentVerseNum = null;
      let currentVerseText = "";
      let expectChapterSubhead = false;
      let sawTitle = false;

      function flushVerse() {
        if (currentVerseNum !== null) {
          addVerse(String(currentVerseNum), currentVerseText.trim());
          addSpacer();
          currentVerseNum = null;
          currentVerseText = "";
        }
      }

      for (const line of lines) {
        const t = line.trim();

        if (!t) {
          flushVerse();
          addSpacer();
          continue;
        }

        // Title (only once)
        if (!sawTitle && t.toLowerCase() === "story of enoch") {
          flushVerse();
          addBlock(t, "title");
          addSpacer();
          sawTitle = true;
          continue;
        }

        // Book header
        if (/^book\s+\d+\b/i.test(t)) {
          flushVerse();
          addBlock(t, "book");
          addSpacer();
          continue;
        }

        // Chapter header
        if (/^chapter\s+\d+\b/i.test(t)) {
          flushVerse();
          addBlock(t, "chapter");
          addSpacer();
          expectChapterSubhead = true; // NEXT non-empty line is subheading
          continue;
        }

        // Chapter subheading (exactly next line after chapter)
        if (expectChapterSubhead) {
          flushVerse();
          addBlock(t, "subhead");
          addSpacer();
          expectChapterSubhead = false;
          continue;
        }

        // Verse start: "1 ..."
        const m = t.match(/^(\d+)\s+(.*)$/);
        if (m) {
          flushVerse();
          currentVerseNum = Number(m[1]);
          currentVerseText = m[2];
          continue;
        }

        // Verse continuation
        if (currentVerseNum !== null) {
          currentVerseText += (currentVerseText.endsWith("-") ? "" : " ") + t;
        } else {
          // Plain paragraph line (rare in your file, but safe)
          addVerse("", t);
          addSpacer();
        }
      }

      flushVerse();

      // Cursor at end
      const end = document.createElement("div");
      end.className = "verse";
      end.innerHTML = "<div class='vnum'></div><div class='vtext'><span class='cursor'></span></div>";
      content.appendChild(end);

    } catch (err) {
      content.innerHTML = "";
      addBlock("Could not load Story of Enoch.txt", "title");
      addBlock(String(err), "subhead");
    }
  }

  loadText();
</script>
